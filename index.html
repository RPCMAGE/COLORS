<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COLORS - Arcade Betting Game</title>
    <link rel="icon" type="image/png" href="Assets/Images/colors_site.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chat.css">
    <link rel="stylesheet" href="leaderboard.css">
    <link rel="preload" as="image" href="Assets/Images/ColorsIllustrationAnimated.gif">
    <!-- Process and Buffer Polyfills (required for Solana Web3.js in browser) -->
    <script>
        // Set up process polyfill first
        if (typeof process === 'undefined') {
            window.process = { env: {}, version: '', versions: {}, browser: true };
        }
        if (typeof global === 'undefined') {
            window.global = window;
        }
        if (typeof globalThis === 'undefined') {
            window.globalThis = window;
        }
        global.process = window.process;
        globalThis.process = window.process;
    </script>
    <!-- Buffer Polyfill - MUST load before Solana Web3.js -->
    <!-- Use a browser-compatible Buffer polyfill that doesn't require Node.js modules -->
    <!-- We'll create our own Buffer implementation since CDN versions have issues -->
    <script>
        // CRITICAL: Set up Buffer IMMEDIATELY and SYNCHRONOUSLY before Solana loads
        // The buffer library needs to be exposed correctly for browser use
        (function() {
            function setupBuffer() {
                let BufferObj = null;
                
                // The buffer library from CDN exposes Buffer in different ways depending on the build
                // Try all possible locations
                if (typeof Buffer !== 'undefined' && typeof Buffer.from === 'function') {
                    BufferObj = Buffer;
                } else if (typeof window.Buffer !== 'undefined' && typeof window.Buffer.from === 'function') {
                    BufferObj = window.Buffer;
                } else if (typeof buffer !== 'undefined') {
                    // Check buffer.Buffer (most common)
                    if (buffer.Buffer && typeof buffer.Buffer.from === 'function') {
                        BufferObj = buffer.Buffer;
                    }
                    // Check buffer.default.Buffer (ES6 module default export)
                    else if (buffer.default && buffer.default.Buffer && typeof buffer.default.Buffer.from === 'function') {
                        BufferObj = buffer.default.Buffer;
                    }
                    // Check if buffer itself is the Buffer constructor
                    else if (typeof buffer === 'function' && typeof buffer.from === 'function') {
                        BufferObj = buffer;
                    }
                    // Check if it's an object with Buffer property
                    else if (buffer && typeof buffer === 'object' && buffer.Buffer && typeof buffer.Buffer.from === 'function') {
                        BufferObj = buffer.Buffer;
                    }
                }
                
                // If still not found, try to create a minimal Buffer polyfill using Uint8Array
                if (!BufferObj || typeof BufferObj.from !== 'function') {
                    console.warn('Buffer library not found, creating minimal polyfill');
                    // Create a minimal Buffer implementation
                    BufferObj = function Buffer(arg) {
                        if (typeof arg === 'number') {
                            return new Uint8Array(arg);
                        } else if (typeof arg === 'string') {
                            const encoder = new TextEncoder();
                            return encoder.encode(arg);
                        } else if (arg instanceof ArrayBuffer) {
                            return new Uint8Array(arg);
                        } else if (Array.isArray(arg)) {
                            return new Uint8Array(arg);
                        }
                        return new Uint8Array(0);
                    };
                    
                    // Add static methods
                    BufferObj.from = function(arg, encoding) {
                        if (typeof arg === 'string') {
                            if (encoding === 'hex') {
                                const bytes = [];
                                for (let i = 0; i < arg.length; i += 2) {
                                    bytes.push(parseInt(arg.substr(i, 2), 16));
                                }
                                return new Uint8Array(bytes);
                            }
                            const encoder = new TextEncoder();
                            return encoder.encode(arg);
                        } else if (arg instanceof ArrayBuffer) {
                            return new Uint8Array(arg);
                        } else if (Array.isArray(arg)) {
                            return new Uint8Array(arg);
                        } else if (arg instanceof Uint8Array) {
                            return new Uint8Array(arg);
                        }
                        return new Uint8Array(0);
                    };
                    
                    BufferObj.alloc = function(size, fill) {
                        const arr = new Uint8Array(size);
                        if (fill !== undefined) {
                            arr.fill(fill);
                        }
                        return arr;
                    };
                    
                    BufferObj.isBuffer = function(obj) {
                        return obj instanceof Uint8Array;
                    };
                }
                
                if (BufferObj && typeof BufferObj.from === 'function') {
                    // Set Buffer EVERYWHERE - Solana Web3.js checks multiple places
                    window.Buffer = BufferObj;
                    if (typeof global === 'undefined') {
                        window.global = window;
                    }
                    global.Buffer = BufferObj;
                    if (typeof globalThis === 'undefined') {
                        window.globalThis = window;
                    }
                    globalThis.Buffer = BufferObj;
                    if (typeof process !== 'undefined') {
                        process.Buffer = BufferObj;
                    }
                    
                    // Verify it works
                    try {
                        const test = BufferObj.from('test');
                        if (test instanceof Uint8Array) {
                            console.log('‚úì Buffer polyfill set up successfully');
                            return true;
                        } else {
                            console.error('Buffer test failed: result is not Uint8Array');
                            return false;
                        }
                    } catch (e) {
                        console.error('Buffer test failed:', e);
                        return false;
                    }
                } else {
                    console.error('CRITICAL: Could not set up Buffer!');
                    return false;
                }
            }
            
            // Try immediately (script should be loaded by now)
            if (!setupBuffer()) {
                // Retry after a short delay in case script is still loading
                setTimeout(function() {
                    if (!setupBuffer()) {
                        console.error('CRITICAL: Buffer polyfill failed to load! Solana Web3.js will fail.');
                    }
                }, 100);
            }
        })();
    </script>
    <!-- Solana Web3.js - Use IIFE bundle (will use Buffer during initialization) -->
    <!-- IMPORTANT: Buffer MUST be available before this script loads -->
    <script>
        // Verify Buffer is available before loading Solana
        if (typeof Buffer === 'undefined' || typeof Buffer.from !== 'function') {
            console.error('CRITICAL ERROR: Buffer is not available! Solana Web3.js will fail.');
            throw new Error('Buffer polyfill not loaded. Please refresh the page.');
        }
        console.log('‚úì Buffer verified before Solana Web3.js load');
    </script>
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js" onload="console.log('Solana Web3.js script loaded')" onerror="console.error('Failed to load Solana Web3.js')"></script>
    <script>
        // Expose Solana Web3.js globally immediately after it loads
        (function() {
            function exposeSolana() {
                // The IIFE bundle should expose solanaWeb3 globally
                if (typeof solanaWeb3 !== 'undefined') {
                    window.solanaWeb3 = solanaWeb3;
                    console.log('Solana Web3.js exposed successfully');
                    return true;
                }
                
                // Check if it's available under a different name
                if (typeof window.web3 !== 'undefined' && window.web3.solana) {
                    window.solanaWeb3 = window.web3.solana;
                    console.log('Solana Web3.js loaded from window.web3');
                    return true;
                }
                
                return false;
            }
            
            // Try immediately
            if (!exposeSolana()) {
                // If not available yet, wait for it
                const checkInterval = setInterval(function() {
                    if (exposeSolana()) {
                        clearInterval(checkInterval);
                    }
                }, 100);
                
                // Stop checking after 5 seconds
                setTimeout(function() {
                    clearInterval(checkInterval);
                    if (!window.solanaWeb3) {
                        console.error('Solana Web3.js failed to load');
                    }
                }, 5000);
            }
        })();
    </script>
</head>
<body>
    <!-- Background Music -->
    <audio id="backgroundMusic" loop preload="auto">
        <source src="Assets/Audio/Ambient_background_music.wav" type="audio/wav">
    </audio>
    
    <!-- Intro Screen Background Music -->
    <audio id="introBackgroundMusic" loop preload="auto">
        <source src="Assets/Audio/Ambient_background_music.wav" type="audio/wav">
    </audio>

    <!-- Header Bar -->
    <header class="header">
        <!-- Game Mode Selector (Demo/Solana) -->
        <div class="game-mode-selector">
            <button class="game-mode-btn active" data-game-mode="demo" id="demoModeBtn">Demo</button>
            <button class="game-mode-btn" data-game-mode="solana" id="solanaModeBtn">Solana</button>
        </div>
        <img src="Assets/Images/logo.gif" alt="COLORS" class="logo">
        <div class="header-controls">
            <!-- Wallet Connection Status (Solana Mode Only) -->
            <div class="wallet-status" id="walletStatus" style="display: none;">
                <span class="wallet-address" id="walletAddress"></span>
                <button class="wallet-connect-btn" id="walletConnectBtn">Connect Wallet</button>
            </div>
            <button class="info-btn" id="infoBtn" title="Game Info & Rules">‚ÑπÔ∏è</button>
            <button class="music-toggle-btn" id="musicToggleBtn" title="Toggle Music">Play music</button>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="normal">Normal</button>
                <button class="mode-btn" data-mode="timeattack">Time Attack</button>
            </div>
        </div>
    </header>

    <!-- Intro Screen -->
    <div class="intro-screen" id="introScreen">
        <!-- Instruction Text -->
        <div class="intro-instruction-text">Click the colors logo to access</div>
        <div class="intro-illustration-container">
            <img src="Assets/Images/ColorsIllustrationAnimated.gif" alt="COLORS Arcade" class="intro-illustration">
            <div class="arcade-logo-clickable-area" id="arcadeLogoClickable"></div>
        </div>
        <!-- Mute Toggle Button (Lower Right) -->
        <button class="intro-mute-toggle-btn" id="introMuteToggleBtn" title="Toggle Music">
            <span id="introMuteIcon">üîä</span>
        </button>
    </div>

    <!-- Access Code Overlay -->
    <div class="access-code-overlay" id="accessCodeOverlay" style="display: none;">
        <div class="access-code-modal">
            <h2 class="access-code-title">üîí Enter Access Code to Unlock</h2>
            <input type="text" id="accessCodeInput" class="access-code-input" placeholder="Enter access code" autocomplete="off">
            <button class="access-code-submit-btn" id="accessCodeSubmitBtn">Unlock</button>
            <p class="access-code-error" id="accessCodeError"></p>
        </div>
    </div>

    <!-- Main Game Area -->
    <main class="game-container" id="mainGame" style="display: none;">
        <!-- Confetti Overlay -->
        <div class="confetti-overlay" id="confettiOverlay"></div>

        <!-- Main Layout: Dice, Colors, Controls -->
        <div class="main-game-layout">
            <!-- Left Side: Dice and Colors -->
            <div class="left-panel">
                <!-- Big Dice -->
                <div class="dice-zone">
                    <div class="dice-container">
                        <div class="dice" id="dice1"></div>
                        <div class="dice" id="dice2"></div>
                        <div class="dice" id="dice3"></div>
                    </div>
                </div>

                <!-- Color Buttons Below Dice -->
                <div class="betting-area">
                    <h3 class="betting-title">Select Colors (Up to 3)</h3>
                    <div class="color-buttons">
                        <button class="color-btn" data-color="yellow">
                            <span class="color-name">Yellow</span>
                            <span class="bet-amount" data-color="yellow">0</span>
                        </button>
                        <button class="color-btn" data-color="orange">
                            <span class="color-name">Orange</span>
                            <span class="bet-amount" data-color="orange">0</span>
                        </button>
                        <button class="color-btn" data-color="pink">
                            <span class="color-name">Pink</span>
                            <span class="bet-amount" data-color="pink">0</span>
                        </button>
                        <button class="color-btn" data-color="blue">
                            <span class="color-name">Blue</span>
                            <span class="bet-amount" data-color="blue">0</span>
                        </button>
                        <button class="color-btn" data-color="green">
                            <span class="color-name">Green</span>
                            <span class="bet-amount" data-color="green">0</span>
                        </button>
                        <button class="color-btn" data-color="red">
                            <span class="color-name">Red</span>
                            <span class="bet-amount" data-color="red">0</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Side: Balance, Bet Controls, Roll Button -->
            <div class="controls-panel">
                <div class="balance-display">
                    <span class="label">Balance:</span>
                    <span class="value" id="balance">1000</span>
                </div>
                <div class="bet-controls">
                    <label for="betAmount">Bet Amount <span id="betCurrency">(points)</span>:</label>
                    <input type="number" id="betAmount" min="1" value="100" step="10">
                    <button class="action-btn" id="placeBetBtn">Place Bet</button>
                    <button class="action-btn" id="clearBetBtn">Clear</button>
                </div>
                <button class="roll-btn" id="rollBtn">ROLL</button>
            </div>
        </div>

        <!-- Result Display -->
        <div class="result-display" id="resultDisplay">
            <div class="result-content">
                <h3 id="resultTitle"></h3>
                <p id="resultText"></p>
                <button class="result-fairness-btn" id="resultFairnessBtn">View Fairness</button>
                <button class="result-twitter-share-btn" id="resultTwitterShareBtn" style="display: none;">Share Win on X</button>
                <button class="result-ok-btn" id="resultOkBtn">OK</button>
            </div>
        </div>

        <!-- Game Info Modal -->
        <div class="info-modal" id="infoModal">
            <div class="info-modal-content">
                <div class="info-modal-header">
                    <h2>üé≤ COLORS Game Rules</h2>
                    <button class="info-modal-close" id="infoModalClose">√ó</button>
                </div>
                <div class="info-modal-body">
                    <h3>How to Play</h3>
                    <p>Bet on up to 3 colors from 6 options: Yellow, Orange, Pink, Blue, Green, Red.</p>
                    <p>Three dice are rolled. Win if any of your selected colors match the dice results!</p>
                    
                    <h3>Payouts</h3>
                    <div class="payout-info">
                        <h4>Normal Mode (5% house edge)</h4>
                        <ul>
                            <li>1 match: Bet + (Bet √ó 1.04)</li>
                            <li>2 matches: Bet + (Bet √ó 1.04 √ó 2)</li>
                            <li>3 matches (Jackpot): Bet + (Bet √ó 4.5)</li>
                        </ul>
                        <h4>Time Attack Mode (3% house edge)</h4>
                        <ul>
                            <li>1 match: Bet + (Bet √ó 1.08)</li>
                            <li>2 matches: Bet + (Bet √ó 1.08 √ó 2)</li>
                            <li>3 matches (Jackpot): Bet + (Bet √ó 5.0)</li>
                        </ul>
                    </div>
                    
                    <h3>Game Modes</h3>
                    <p><strong>Normal:</strong> Standard pace, safer multipliers for longer sessions.</p>
                    <p><strong>Time Attack:</strong> Fast-paced mode with 10-second timer. Higher multipliers. Skip 2 rounds if you don't bet in time!</p>
                    
                    <h3>Fairness</h3>
                    <p>All dice rolls use cryptographically secure random number generation. View the "Fairness" details after each roll to see the exact results and calculations.</p>
                </div>
            </div>
        </div>

        <!-- Fairness Display Modal -->
        <div class="fairness-modal" id="fairnessModal">
            <div class="fairness-modal-content">
                <div class="fairness-modal-header">
                    <h2>üîç Fairness Verification</h2>
                    <button class="fairness-modal-close" id="fairnessModalClose">√ó</button>
                </div>
                <div class="fairness-modal-body" id="fairnessContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Time Attack Timer -->
        <div class="timer-display" id="timerDisplay">
            <div class="timer-bar">
                <div class="timer-fill" id="timerFill"></div>
            </div>
            <span class="timer-text" id="timerText">10</span>
        </div>

        <!-- Betting Lock Notification -->
        <div class="betting-lock-notification" id="bettingLockNotification">
            <div class="betting-lock-content">
                <h2 class="betting-lock-title">‚è±Ô∏è Round Ended</h2>
                <p class="betting-lock-message">Betting is now locked. Please wait for the next round.</p>
                <div class="betting-lock-countdown">
                    <span class="betting-lock-countdown-label">Next round in:</span>
                    <span class="betting-lock-countdown-value" id="bettingLockCountdown">20</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Demo showcase for COLORS</p>
    </footer>

    <!-- Chat Module -->
    <button class="chat-toggle-btn" id="chatToggleBtn" title="Toggle Chat">üí¨</button>
    
    <div class="chat-username-modal" id="chatUsernameModal">
        <div class="chat-username-modal-content">
            <h3>Choose Your Username</h3>
            <p>Pick a username to start chatting with other players!</p>
            <input type="text" id="chatUsernameInput" class="chat-username-input" placeholder="Enter username (max 20 chars)" maxlength="20">
            <button class="chat-username-submit" onclick="window.chatModule.setUsername()">Start Chatting</button>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <span class="chat-title">üí¨ Chat</span>
            <button class="chat-close" onclick="window.chatModule.toggleChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
            <input type="text" id="chatMessageInput" class="chat-input" placeholder="Type a message..." maxlength="500">
            <button class="chat-send-btn" onclick="window.chatModule.sendMessage()">Send</button>
        </div>
    </div>
    
    <script>
    </script>
    <script>
        // Allow Enter key to send chat messages and setup toggle button
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && window.chatModule) {
                        window.chatModule.sendMessage();
                    }
                });
            }
            
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            if (chatToggleBtn && window.chatModule) {
                chatToggleBtn.addEventListener('click', function() {
                    window.chatModule.toggleChat();
                });
            }
        });
    </script>

    <!-- Leaderboard Module -->
    <button class="leaderboard-toggle-btn" id="leaderboardToggleBtn" onclick="window.leaderboardModule.toggleLeaderboard()">üèÜ Leaderboard</button>
    
    <div class="leaderboard-container" id="leaderboardContainer">
        <div class="leaderboard-header">
            <span class="leaderboard-title">üèÜ Top Winners</span>
            <button class="leaderboard-close" onclick="window.leaderboardModule.toggleLeaderboard()">√ó</button>
        </div>
        <div class="leaderboard-list" id="leaderboardList"></div>
    </div>

    <script src="wallet.js"></script>
    <script src="solana-betting.js"></script>
    <script src="chat.js"></script>
    <script src="leaderboard.js"></script>
    <script src="access-code.js"></script>
    <script src="main.js"></script>
    <script>
        // Initialize Solana Web3.js global
        if (typeof solanaWeb3 !== 'undefined') {
            window.solanaWeb3 = solanaWeb3;
        }
    </script>
</body>
</html>

